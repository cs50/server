##########################################################################
#  Passenger Standalone is built on the same technology that powers
#  Passenger for Nginx, so any configuration option supported by Passenger
#  for Nginx can be applied to Passenger Standalone as well. You can do
#  this by direct editing the Nginx configuration template that is used by
#  Passenger Standalone.
#
#  This file is the original template. DO NOT EDIT THIS FILE DIRECTLY.
#  Instead, make a copy of this file and pass the `--nginx-config-template`
#  parameter to Passenger Standalone.
#
#  Learn more about using the Nginx configuration template at:
#  https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template
#
#  *** NOTE ***
#  If you customize the template file, make sure you keep an eye on the
#  original template file and merge any changes. New Phusion Passenger
#  features may require changes to the template file.
##############################################################

<%= include_passenger_internal_template('global.erb') %>

worker_processes 1;
events {
    worker_connections 4096;
}

http {
    <%= include_passenger_internal_template('http.erb', 4) %>

    ### BEGIN your own configuration options ###
    # This is a good place to put your own config
    # options. Note that your options must not
    # conflict with the ones Passenger already sets.
    # Learn more at:
    # https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template

    # Determine real scheme
    # http://stackoverflow.com/a/21911864
    map $http_x_forwarded_proto $real_scheme {
        default $http_x_forwarded_proto;
        '' $scheme;
    }

    # Issue relative redirects
    # http://nginx.org/en/docs/http/ngx_http_core_module.html#absolute_redirect
    absolute_redirect off;

    # Include newer MIME types than Passenger includes
    # https://github.com/nginx/nginx/blob/master/conf/mime.types
    include '/opt/nginx/conf/mime.types';

    # Remove headers
    more_clear_headers 'Server';
    more_clear_headers 'X-Powered-By';

    # Suppress log prefix
    # https://github.com/phusion/passenger/pull/2176
    passenger_disable_log_prefix on;

    <% if File.file?("#{@apps[0][:root]}/http.conf") %>
    # http context
    include <%= "#{@apps[0][:root]}/http.conf" %>;
    <% end %>

    ### END your own configuration options ###

    default_type application/octet-stream;
    types_hash_max_size 2048;
    server_names_hash_bucket_size 64;
    client_max_body_size 1024m;
    access_log off;
    keepalive_timeout 60;
    underscores_in_headers on;
    gzip on;
    gzip_comp_level 3;
    gzip_min_length 150;
    gzip_proxied any;
    gzip_types text/plain text/css text/json text/javascript
        application/javascript application/x-javascript application/json
        application/rss+xml application/vnd.ms-fontobject application/x-font-ttf
        application/xml font/opentype image/svg+xml text/xml;

    <% if @app_finder.multi_mode? %>
        # Default server entry for mass deployment mode.
        server {
            <%= include_passenger_internal_template('mass_deployment_default_server.erb', 12) %>
        }
    <% end %>

    <% for app in @apps[0,1] %>
    server {
        <%= include_passenger_internal_template('server.erb', 8, true, binding) %>
        <%= include_passenger_internal_template('rails_asset_pipeline.erb', 8, false) %>

        ### BEGIN your own configuration options ###
        # This is a good place to put your own config
        # options. Note that your options must not
        # conflict with the ones Passenger already sets.
        # Learn more at:
        # https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template

        # Disable caching
        # https://stackoverflow.com/a/2068407/5156190
        more_set_headers 'Cache-Control: no-cache, no-store, must-revalidate';
        more_set_headers 'Expires: 0';
        more_set_headers 'Pragma: no-cache';

        # Disallow iframing
        # https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors
        more_set_headers "Content-Security-Policy: frame-ancestors 'self'";

        # Redirect directory to directory/ (but with real scheme)
        if (-d $request_filename) {
            rewrite [^/]$ $real_scheme://$http_host$uri/ permanent;
        }

        # Redirect to HTTPS if behind load balancer
        if ($http_x_forwarded_proto = 'http') {
            return 301 https://$host$request_uri;
        }

        # Send HSTS header in production
        <% if ENV["PASSENGER_ENVIRONMENT"] == "production" %>
        more_set_headers "Strict-Transport-Security: max-age=60";
        <% end %>

        # Omit port from rewrites in server.conf 
        <% if ENV["PASSENGER_ENVIRONMENT"] == "production" %>
        port_in_redirect off;
        <% end %>

        <% if !app[:app_type] && !AppFinder::STARTUP_FILES.any? do |file| File.exist?("#{@apps[0][:root]}/#{file}") end %>
        # Assume PHP if autodetection fails
        # https://www.phusionpassenger.com/library/indepth/ruby/app_autodetection/standalone/
        index index.html index.php;
        location ~ \.php$ {
            fastcgi_param HTTP_X_FORWARDED_HOST $host;
            fastcgi_param HTTP_X_FORWARDED_SERVER $host;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param SERVER_NAME $host;
            fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            include /usr/local/etc/fastcgi_params;
            try_files $uri =404;
        }
        <% end %>

        <% if File.file?("#{@apps[0][:root]}/server.conf") %>
        # server context
        include <%= "#{@apps[0][:root]}/server.conf" %>;
        <% end %>

        ### END your own configuration options ###
    }
    passenger_pre_start <%= listen_url(@apps[0]) %>;
    <% end %>

    <%= include_passenger_internal_template('footer.erb', 4) %>
}
